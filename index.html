<!DOCTYPE html>
<html lang="en">
<head>
    <script type="module">
      import { add, factorial, normalJS, greet, addInt, sumArray, doubleArray, addPoints, processOuter, sumMatrix, transformPoints } from '/src/index.ts';
      import { multiplyMatrix } from '/src/matrix.ts';
      import { testCallback, getFunc, getAdder, addGlobal } from '/src/callback_test.ts';
      import { createComplex, processComplex } from '/src/object_test.ts';
      import { createMixed, callMixed } from '/src/mixed_test.ts';
      import { Rect, createRect, scaleRect, rectArea } from '/src/class_test.ts';
      
      console.log('Running tests from browser...');

      function assert(actual, expected, message) {
          const actualStr = JSON.stringify(actual);
          const expectedStr = JSON.stringify(expected);
          const passed = actualStr === expectedStr;
          const status = passed ? '<span style="color:green">✅ PASS</span>' : '<span style="color:red">❌ FAIL</span>';
          
          console.log(`${passed ? 'PASS' : 'FAIL'}: ${message}`);
          if (!passed) {
              console.log(`  Expected: ${expectedStr}`);
              console.log(`  Actual:   ${actualStr}`);
          }

          document.body.innerHTML += `
            <div style="margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                <strong>${message}</strong><br>
                Result: ${actualStr} <br>
                ${status}
            </div>
          `;
      }

      // Basic Types
      assert(add(10, 20), 200, 'add(10, 20) [should be 200 (10*20)]');
      assert(factorial(5), 120, 'factorial(5)');
      assert(normalJS(5), 10, 'normalJS(5)');
      assert(greet("World"), "Hello, World", 'greet("World")');
      assert(addInt(5, 7), 12, 'addInt(5, 7)');

      // Arrays
      assert(sumArray([1, 2, 3, 4, 5]), 15, 'sumArray([1, 2, 3, 4, 5])');
      assert(doubleArray([1, 2, 3]), [2, 4, 6], 'doubleArray([1, 2, 3])');

      // Objects
      const p1 = { x: 10, y: 20 };
      const p2 = { x: 5, y: 5 };
      const p3 = addPoints(p1, p2);
      assert(p3, { x: 15, y: 25 }, 'addPoints({x:10, y:20}, {x:5, y:5})');

      // Nested Objects
      const outer = {
        name: "Test",
        inner: { val: 42 },
        list: [1, 2, 3]
      };
      const processed = processOuter(outer);
      assert(processed, {
          name: "Processed Test",
          inner: { val: 43 },
          list: [2, 4, 6]
      }, 'processOuter(...)');

      // Matrix Multiplication
      const m1 = {
        rows: 2,
        cols: 2,
        data: [1, 2, 3, 4] 
      };
      const m2 = {
        rows: 2,
        cols: 2,
        data: [5, 6, 7, 8] 
      };
      const mResult = multiplyMatrix(m1, m2);
      assert(mResult, {
          rows: 2,
          cols: 2,
          data: [19, 22, 43, 50]
      }, 'multiplyMatrix(A, B)');

      // Nested Arrays
      const matrix = [[1, 2], [3, 4]];
      const matrixSum = sumMatrix(matrix);
      assert(matrixSum, 10, 'sumMatrix([[1, 2], [3, 4]])');

      // Array of Objects
      const points = [{x: 1, y: 1}, {x: 2, y: 2}];
      const transformedPoints = transformPoints(points);
      assert(transformedPoints, [{x: 2, y: 2}, {x: 4, y: 4}], 'transformPoints(...)');

      // Callbacks
      const cbRes = testCallback((v) => v * 2);
      assert(cbRes, 42, 'testCallback((v) => v * 2) with input 21');

      // Returning Functions
      const fn = getFunc();
      assert(fn(10), 20, 'getFunc()(10)');

      // Closures
      const adder = getAdder(5); // x=1, amount=5. v*2 + 1 + 5
      assert(adder(10), 26, 'getAdder(5)(10) -> 10*2 + 1 + 5 = 26');
      
      const adder2 = getAdder(10); // x=1, amount=10. v*2 + 1 + 10
      assert(adder2(10), 31, 'getAdder(10)(10) -> 10*2 + 1 + 10 = 31');

      // Globals
      assert(addGlobal(5), 15, 'addGlobal(5) -> 5 + 10 = 15');

      // Object Tests
      try {
        console.log("Testing Objects...");
        const complex = createComplex(5);
        console.log('Complex Object:', complex);
        assert(complex.id, 5, "Complex ID");
        assert(complex.list.length, 3, "Complex List Length");
        assert(complex.nested.val, 100, "Complex Nested Val");
        
        // Test methods
        const res1 = complex.nested.fn(10);
        assert(res1, 11, "Complex Nested Fn (10+1)");
        
        const res2 = complex.processor(10);
        assert(res2, 50, "Complex Processor (10*5)");
        
        // Test passing object back to Wasm
        const res3 = processComplex(complex);
        // processComplex: obj.processor(obj.nested.val) + obj.nested.fn(10)
        // processor(100) = 100 * 5 = 500
        // nested.fn(10) = 10 + 1 = 11
        // Total = 511
        assert(res3, 511, "Process Complex Object in Wasm");
      } catch (e) {
        console.error("Object Test Failed", e);
        document.body.innerHTML += `<div style="color:red">Object Test Failed: ${e.message}</div>`;
      }

      // Mixed Tests
      try {
        console.log("Testing Mixed Wasm/JS...");
        const mixed = createMixed();
        console.log('Mixed Object:', mixed);
        
        // Test Wasm Fn
        assert(mixed.wasmFn(), 42, "Mixed Wasm Fn");
        
        // Test JS Fn
        assert(mixed.jsFn(), 100, "Mixed JS Fn");
        
        // Test Round Trip
        const res = callMixed(mixed);
        assert(res, 142, "Mixed Round Trip (42 + 100)");
        
      } catch (e) {
        console.error("Mixed Test Failed", e);
        document.body.innerHTML += `<div style="color:red">Mixed Test Failed: ${e.message}</div>`;
      }

      // Class Tests
      try {
        console.log("Testing Classes...");
        
        // 1. Create Rect in Wasm
        const r1 = createRect(0, 0, 10, 20);
        console.log('Rect from Wasm:', r1);
        assert(r1.width, 10, "Rect Width");
        assert(r1.height, 20, "Rect Height");
        
        // 2. Pass Rect to Wasm
        const area = rectArea(r1);
        assert(area, 200, "Rect Area (Wasm)");
        
        // 3. Pass JS Class Instance to Wasm
        const r2 = new Rect(10, 10, 5, 5);
        const area2 = rectArea(r2);
        assert(area2, 25, "JS Rect Instance Area (Wasm)");
        
        // 4. Return modified Rect
        const r3 = scaleRect(r2, 2);
        assert(r3.width, 10, "Scaled Rect Width");
        assert(r3.height, 10, "Scaled Rect Height");
        
      } catch (e) {
        console.error("Class Test Failed", e);
        document.body.innerHTML += `<div style="color:red">Class Test Failed: ${e.message}</div>`;
      }

    </script>
</head>
<body>
    <h2>JSW Automated Tests</h2>
</body>
</html>
