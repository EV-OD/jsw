<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JS vs JSW Neural Network Training</title>
  <style>
    :root {
      --primary: #3f51b5;
      --primary-dark: #303f9f;
      --accent: #f50057;
      --bg: #f0f2f5;
      --card-bg: #ffffff;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --border: #d2d2d7;
      --class-0: #1f77b4; /* Blue */
      --class-1: #ff7f0e; /* Orange */
      --class-0-bg: rgba(31, 119, 180, 0.4);
      --class-1-bg: rgba(255, 127, 14, 0.4);
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 0 2rem;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      z-index: 10;
    }
    h1 { margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--text); }
    .badge {
      background: #eee;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      color: #666;
    }

    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    aside {
      width: 300px;
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 1.5rem;
      gap: 1.5rem;
      z-index: 5;
    }

    .control-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    button {
      background: white;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.1s;
      font-weight: 500;
      display: block;
      width: 100%;
      text-align: center;
    }
    button:hover { background: #f5f5f7; border-color: #c7c7cc; }
    button:active { background: #e5e5ea; transform: translateY(1px); }
    button.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 2px 4px rgba(63, 81, 181, 0.3);
    }
    button.primary:hover { background: var(--primary-dark); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f5f5f7;
      padding: 4px;
      border-radius: 8px;
    }
    .toggle-opt {
      flex: 1;
      text-align: center;
      padding: 6px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
    }
    .toggle-opt.active {
      background: white;
      opacity: 1;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .toggle-opt.blue.active { color: var(--class-0); }
    .toggle-opt.orange.active { color: var(--class-1); }

    .stats-card {
      background: #f5f5f7;
      border-radius: 8px;
      padding: 1rem;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    .stat-row:last-child { margin-bottom: 0; }
    .stat-val { font-family: monospace; font-weight: 600; }

    input[type="number"] {
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px 8px;
      font-family: inherit;
      width: 100%;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: linear-gradient(to bottom right, #f0f2f5, #eef2f5);
      padding: 2rem;
      gap: 2rem;
      overflow-y: auto;
    }

    .canvas-wrapper {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 1rem;
      align-self: center;
      position: relative;
    }
    
    canvas {
      display: block;
      border-radius: 4px;
      cursor: crosshair;
      background: #fff;
      border: 1px solid #eee;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }

    .weights-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }
    .model-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      height: 400px;
      position: relative;
    }
    .model-header {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
    }
    .network-container {
      flex: 1;
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }
    
    /* Network Viz Styles */
    svg { width: 100%; height: 100%; }
    .node-circle { stroke: #333; stroke-width: 1.5; fill: #fff; cursor: pointer; }
    .node-circle:hover { stroke-width: 2.5; }
    .edge-line { stroke-linecap: round; transition: stroke-width 0.2s; cursor: pointer; }
    .edge-line:hover { stroke-width: 4 !important; opacity: 1 !important; }

    .tooltip-float {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      pointer-events: none;
      transform: translate(-50%, -100%);
      margin-top: -10px;
      z-index: 100;
      display: none;
      white-space: nowrap;
    }

    .benchmark-results {
      background: white; 
      padding: 1.5rem; 
      border-radius: 8px; 
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 1rem; }
    th { text-align: left; padding: 8px; background: #f8f9fa; border-bottom: 2px solid #eee; }
    td { padding: 8px; border-bottom: 1px solid #eee; }
    
    .info-toast {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    .info-toast.show { opacity: 0.9; }

  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <h1>Neural Network Playground</h1>
      <span class="badge">JSW vs JS</span>
    </div>
    <div>
      <a href="/" style="text-decoration:none; color:var(--text); font-size:0.9rem;">&larr; Back to Index</a>
    </div>
  </header>

  <div class="container">
    <aside>
      <div class="control-section">
        <div class="section-title">Data Generation</div>
        <button id="loadLinearBtn">Generate Linear Data</button>
        <button id="clearBtn">Clear All</button>
      </div>

      <div class="control-section">
        <div class="section-title">Class Label</div>
        <div class="toggle-row">
          <div id="btnBlue" class="toggle-opt blue active">Blue (0)</div>
          <div id="btnOrange" class="toggle-opt orange">Orange (1)</div>
        </div>
        <div style="font-size:0.8rem; color:#888; text-align:center; margin-top:4px;">Click canvas to add points</div>
      </div>

      <div class="control-section">
        <div class="section-title">Training</div>
        <button id="trainBtn" class="primary" style="margin-bottom:8px">Train Once</button>
        <div style="display:flex; gap:8px;">
          <button id="showJs">Show JS</button>
          <button id="showWasm">Show JSW</button>
        </div>
      </div>

      <div class="control-section">
        <div class="section-title">Benchmark</div>
        <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
          <input type="number" id="benchRuns" value="10" min="1" max="1000" style="width:70px" />
          <span style="font-size:0.8rem;">runs</span>
        </div>
        <button id="btnBenchmark">Run Benchmark</button>
        <button id="btnDownloadCsv" disabled style="margin-top:8px;">Download CSV</button>
      </div>

      <div class="control-section">
        <div class="section-title">Performance Stats</div>
        <div class="stats-card">
          <div class="stat-row">
            <span>JS Time:</span>
            <span class="stat-val" id="jsTime">-</span>
          </div>
          <div class="stat-row">
            <span>JSW Time:</span>
            <span class="stat-val" id="wasmTime">-</span>
          </div>
          <div style="height:1px; background:#ddd; margin:8px 0;"></div>
          <div class="stat-row">
            <span>JS Loss:</span>
            <span class="stat-val" id="jsLoss">-</span>
          </div>
          <div class="stat-row">
            <span>JSW Loss:</span>
            <span class="stat-val" id="wasmLoss">-</span>
          </div>
        </div>
      </div>
    </aside>

    <main>
      <div class="info-toast" id="toast">Training Complete</div>
      
      <div class="canvas-wrapper">
        <canvas id="c" width="600" height="400"></canvas>
        <div class="legend">
          <div style="display:flex; align-items:center;"><span class="dot" style="background:var(--class-0);"></span> Class 0</div>
          <div style="display:flex; align-items:center;"><span class="dot" style="background:var(--class-1);"></span> Class 1</div>
        </div>
      </div>

      <div class="weights-panel">
        <div class="model-card">
          <div class="model-header">
            <span>JS Model Weights</span>
            <span style="font-size:0.8rem; opacity:0.7">Network Visualization</span>
          </div>
          <div id="jsNet" class="network-container">
            <div style="padding:20px; color:#999; text-align:center; margin-top:100px;">Train to see network</div>
          </div>
          <div id="jsTooltip" class="tooltip-float"></div>
        </div>
        <div class="model-card">
          <div class="model-header">
            <span>JSW Model Weights</span>
            <span style="font-size:0.8rem; opacity:0.7">Network Visualization</span>
          </div>
          <div id="wasmNet" class="network-container">
             <div style="padding:20px; color:#999; text-align:center; margin-top:100px;">Train to see network</div>
          </div>
          <div id="wasmTooltip" class="tooltip-float"></div>
        </div>
      </div>

      <div class="benchmark-results" id="benchPanel">
          <h3 style="margin-top:0;">Benchmark Results</h3>
          <canvas id="benchChart" width="800" height="200" style="width:100%; height:200px; margin-bottom: 2rem; border:1px solid #eee; border-radius:4px;"></canvas>
          <div style="overflow-x:auto; max-height: 300px;">
              <table id="benchTable">
                  <thead style="position:sticky; top:0;">
                      <tr style="background:#f5f5f7;">
                          <th>Run</th>
                          <th>JS Time (ms)</th>
                          <th>JSW Time (ms)</th>
                          <th>JS Loss</th>
                          <th>JSW Loss</th>
                      </tr>
                  </thead>
                  <tbody></tbody>
              </table>
          </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { trainModelWasm, predictWasm } from '/src/wasm_backend.ts';
    import { trainModelJs, predictJs } from '/src/pure_backend.ts';

    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const toast = document.getElementById('toast');
    
    // UI State
    let currentLabel = 0; // 0 -> blue, 1 -> orange
    const points = []; // {x, y, label}
    let benchmarkResults = [];

    // Colors
    const COLOR_0 = '#1f77b4';
    const COLOR_1 = '#ff7f0e';
    const COLOR_0_RGB = [31, 119, 180];
    const COLOR_1_RGB = [255, 127, 14];

    // DOM Elements
    const btnBlue = document.getElementById('btnBlue');
    const btnOrange = document.getElementById('btnOrange');
    
    function updateToggleUI() {
      if(currentLabel === 0) {
        btnBlue.classList.add('active');
        btnOrange.classList.remove('active');
      } else {
        btnBlue.classList.remove('active');
        btnOrange.classList.add('active');
      }
    }

    btnBlue.addEventListener('click', () => { currentLabel = 0; updateToggleUI(); });
    btnOrange.addEventListener('click', () => { currentLabel = 1; updateToggleUI(); });

    document.getElementById('clearBtn').addEventListener('click', ()=>{ 
      points.length = 0; 
      drawPoints(); 
      resetResults();
      document.getElementById('jsNet').innerHTML = '<div style="padding:20px; color:#999; text-align:center; margin-top:100px;">Train to see network</div>';
      document.getElementById('wasmNet').innerHTML = '<div style="padding:20px; color:#999; text-align:center; margin-top:100px;">Train to see network</div>';
    });

    canvas.addEventListener('click', (e)=>{
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / canvas.width;
      const y = (e.clientY - rect.top) / canvas.height;
      const label = currentLabel===0 ? [1,0] : [0,1];
      points.push({x,y,label});
      drawPoints();
    });

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 3000);
    }

    function loadLinearData(count = 1000){
      points.length = 0;
      const theta = Math.random() * Math.PI - (Math.PI/2);
      const nx = Math.cos(theta);
      const ny = Math.sin(theta);
      const offset = (Math.random() - 0.5) * 0.2;
      
      for(let i=0;i<count;i++){
        const x = Math.random();
        const y = Math.random();
        const val = nx * x + ny * y - (0.5 + offset);
        const noisy = Math.random() < 0.02; 
        const classIndex = noisy ? (Math.random() < 0.5 ? 0 : 1) : (val > 0 ? 0 : 1);
        const label = classIndex === 0 ? [1,0] : [0,1];
        points.push({x,y,label});
      }
      drawPoints();
      resetResults();
    }

    document.getElementById('loadLinearBtn').addEventListener('click', ()=> loadLinearData(500));

    function drawPoints(preserveBackground = false){
      if(!preserveBackground) {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // Draw faint grid
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let x=0; x<=canvas.width; x+=20) { ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); }
        for(let y=0; y<=canvas.height; y+=20) { ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); }
        ctx.stroke();
      }
      
      for(const p of points){
        ctx.beginPath();
        const isClass0 = p.label[0]===1;
        ctx.fillStyle = isClass0 ? COLOR_0 : COLOR_1;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1.5;
        ctx.arc(p.x*canvas.width, p.y*canvas.height, 6, 0, Math.PI*2);
        ctx.fill();
        ctx.stroke();
      }
    }

    function resetResults(){
      document.getElementById('jsTime').textContent = '-';
      document.getElementById('wasmTime').textContent = '-';
      document.getElementById('jsLoss').textContent = '-';
      document.getElementById('wasmLoss').textContent = '-';
    }

    function modelPredict(model, input, backend){
      if(backend === 'js' && typeof predictJs === 'function') return predictJs(input, model);
      if(backend === 'wasm' && typeof predictWasm === 'function') return predictWasm(input, model);
      throw new Error('predict unavailable');
    }

    function prepareData(){
      const data = points.map(p => [p.x, p.y]);
      const labels = points.map(p => p.label);
      return {data, labels};
    }

    function computeLoss(model, data, labels, backend='js'){
      if(!data || data.length===0) return '-';
      let sum = 0;
      for(let i=0;i<data.length;i++){
        const out = modelPredict(model, data[i], backend);
        if(!out || !out.length) return '-';
        for(let j=0;j<out.length;j++){
          const diff = out[j] - (labels[i][j] || 0);
          sum += diff*diff;
        }
      }
      const val = sum / data.length;
      return isFinite(val) ? val.toFixed(4) : '-';
    }

    // High resolution visualization using ImageData
    function visualizeModel(model, backend='js'){
      const w = canvas.width;
      const h = canvas.height;
      const imageData = ctx.createImageData(w, h);
      const buf = imageData.data;
      
      const stride = 2; 

      for(let y=0; y<h; y+=stride){
        for(let x=0; x<w; x+=stride){
            const nx = x / w;
            const ny = y / h;
            
            const out = modelPredict(model, [nx,ny], backend);
            
            let r,g,b,alpha;
            
            if(out[0] > out[1]) {
                const strength = Math.min(1.0, (out[0] - out[1]) * 2.5); 
                r = COLOR_0_RGB[0]; g = COLOR_0_RGB[1]; b = COLOR_0_RGB[2];
                alpha = 0.1 + (strength * 0.4); 
            } else {
                const strength = Math.min(1.0, (out[1] - out[0]) * 2.5);
                r = COLOR_1_RGB[0]; g = COLOR_1_RGB[1]; b = COLOR_1_RGB[2];
                alpha = 0.1 + (strength * 0.4); 
            }
            
            for(let dy=0; dy<stride && y+dy<h; dy++){
                for(let dx=0; dx<stride && x+dx<w; dx++){
                    const index = ((y+dy)*w + (x+dx)) * 4;
                    buf[index] = r;
                    buf[index+1] = g;
                    buf[index+2] = b;
                    buf[index+3] = alpha * 255;
                }
            }
        }
      }
      
      ctx.putImageData(imageData, 0, 0);
      drawPoints(true);
    }
    
    // SVG Network Visualization
    function drawNetwork(svgId, tooltipId, model) {
        const container = document.getElementById(svgId);
        container.innerHTML = ''; 
        const tooltip = document.getElementById(tooltipId);

        const layers = [
            { count: 2, name: 'Input' }, 
            { count: 5, name: 'Hidden' }, 
            { count: 2, name: 'Output' } 
        ];

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "100%");
        container.appendChild(svg);

        const rect = container.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;
        const padding = 40;
        
        const layerX = (i) => padding + (w - 2*padding) * (i / (layers.length - 1));
        const nodeY = (lIndex, nIndex, nCount) => {
            const availH = h - 2*padding;
            const step = availH / (nCount - 1 || 1);
            if(nCount === 1) return h/2;
            return padding + step * nIndex;
        };

        const getWeight = (lIdx, srcIdx, destIdx) => {
             if(model.weights[lIdx] && model.weights[lIdx][destIdx]) {
                 return model.weights[lIdx][destIdx][srcIdx];
             }
             return 0;
        }

        for(let l=0; l<layers.length-1; l++){
            const srcCount = layers[l].count;
            const destCount = layers[l+1].count;
            
            for(let s=0; s<srcCount; s++){
                for(let d=0; d<destCount; d++){
                    const weight = getWeight(l, s, d);
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    
                    const x1 = layerX(l);
                    const y1 = nodeY(l, s, srcCount);
                    const x2 = layerX(l+1);
                    const y2 = nodeY(l+1, d, destCount);
                    
                    line.setAttribute("x1", x1);
                    line.setAttribute("y1", y1);
                    line.setAttribute("x2", x2);
                    line.setAttribute("y2", y2);
                    line.setAttribute("class", "edge-line");
                    
                    const absW = Math.abs(weight);
                    const width = Math.min(6, Math.max(0.5, absW * 10)); 
                    line.setAttribute("stroke-width", width);
                    
                    line.setAttribute("stroke", weight > 0 ? COLOR_1 : COLOR_0);
                    line.setAttribute("opacity", Math.min(1, 0.3 + absW));
                    
                    line.addEventListener('mousemove', (e) => {
                       tooltip.style.display = 'block'; // Make visible first
                       // Use container's parent (.model-card) as reference since tooltip is a sibling
                       const parentRect = container.parentElement.getBoundingClientRect();
                       tooltip.style.left = (e.clientX - parentRect.left) + 'px';
                       tooltip.style.top = (e.clientY - parentRect.top) + 'px';
                       tooltip.textContent = `w: ${weight.toFixed(4)}`;
                    });
                    line.addEventListener('mouseleave', () => {
                       tooltip.style.display = 'none';
                    });
                    
                    svg.appendChild(line);
                }
            }
        }

        for(let l=0; l<layers.length; l++){
            const count = layers[l].count;
            for(let n=0; n<count; n++){
                const cx = layerX(l);
                const cy = nodeY(l, n, count);
                
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", cx);
                circle.setAttribute("cy", cy);
                circle.setAttribute("r", 8);
                circle.setAttribute("class", "node-circle");
                
                let biasVal = 0;
                if(l > 0 && model.biases[l-1]) biasVal = model.biases[l-1][n];
                
                circle.addEventListener('mousemove', (e) => {
                   tooltip.style.display = 'block'; 
                   const parentRect = container.parentElement.getBoundingClientRect();
                   tooltip.style.left = (e.clientX - parentRect.left) + 'px';
                   tooltip.style.top = (e.clientY - parentRect.top) + 'px';
                   tooltip.textContent = l===0 ? `Input ${n}` : `Bias: ${biasVal.toFixed(4)}`;
                });
                circle.addEventListener('mouseleave', () => {
                   tooltip.style.display = 'none';
                });

                svg.appendChild(circle);
            }
        }
    }

    let lastJsModel = null, lastWasmModel = null;

    document.getElementById('trainBtn').addEventListener('click', async ()=>{
      const {data, labels} = prepareData();
      if(data.length===0){ showToast('Add some points first'); return; }
      
      const trainBtn = document.getElementById('trainBtn');
      trainBtn.disabled = true; 
      trainBtn.textContent = 'Training...';

      setTimeout(() => {
        const t0 = performance.now();
        const jsModel = trainModelJs(data, labels, 100, 0.01);
        const t1 = performance.now();
        document.getElementById('jsTime').textContent = (t1-t0).toFixed(2) + ' ms';
        document.getElementById('jsLoss').textContent = computeLoss(jsModel, data, labels, 'js');
        lastJsModel = jsModel;
        drawNetwork('jsNet', 'jsTooltip', jsModel);

        const w0 = performance.now();
        const wasmModel = trainModelWasm(data, labels, 100, 0.01);
        const w1 = performance.now();
        document.getElementById('wasmTime').textContent = (w1-w0).toFixed(2) + ' ms';
        document.getElementById('wasmLoss').textContent = computeLoss(wasmModel, data, labels, 'wasm');
        lastWasmModel = wasmModel;
        drawNetwork('wasmNet', 'wasmTooltip', wasmModel);

        trainBtn.disabled = false; 
        trainBtn.textContent = 'Train Models';
        showToast('Training Finished');
        
        visualizeModel(lastWasmModel, 'wasm');
      }, 50);
    });

    document.getElementById('showJs').addEventListener('click', ()=>{
      if(!lastJsModel) { showToast('Train first'); return; }
      visualizeModel(lastJsModel, 'js');
      showToast('Showing JS Model');
    });
    document.getElementById('showWasm').addEventListener('click', ()=>{
      if(!lastWasmModel) { showToast('Train first'); return; }
      visualizeModel(lastWasmModel, 'wasm');
      showToast('Showing JSW Model');
    });
    
    // Benchmark Logic
    document.getElementById('btnBenchmark').addEventListener('click', async () => {
        const runs = parseInt(document.getElementById('benchRuns').value, 10) || 10;
        
        const btn = document.getElementById('btnBenchmark');
        btn.disabled = true;
        btn.textContent = `Running (${0}/${runs})...`;
        
        benchmarkResults = [];
        const tableBody = document.querySelector('#benchTable tbody');
        tableBody.innerHTML = '';
        document.getElementById('benchPanel').style.display = 'block';

        // Clear previous summary if exists
        const oldSummary = document.getElementById('benchSummary');
        if(oldSummary) oldSummary.remove();
        
        // Add summary placeholder
        const summaryDiv = document.createElement('div');
        summaryDiv.id = 'benchSummary';
        summaryDiv.style.marginBottom = '1rem';
        summaryDiv.style.fontWeight = '600';
        summaryDiv.innerHTML = 'Calculating averages...';
        document.getElementById('benchPanel').insertBefore(summaryDiv, document.getElementById('benchTable').parentElement);
        
        let i = 0;
        
        function runStep() {
            if(i >= runs) {
                // Done
                btn.disabled = false;
                btn.textContent = 'Run Benchmark';
                document.getElementById('btnDownloadCsv').disabled = false;
                drawBenchChart();

                // Calculate Averages
                const avgJs = benchmarkResults.reduce((s, r)=> s + r.jsTime, 0) / runs;
                const avgWasm = benchmarkResults.reduce((s, r)=> s + r.wasmTime, 0) / runs;
                
                const faster = avgJs > avgWasm ? 'JSW' : 'JS';
                const speedup = faster === 'JSW' ? (avgJs / avgWasm) : (avgWasm / avgJs);

                summaryDiv.innerHTML = `
                    <span style="color:#f44336">Avg JS Time: ${avgJs.toFixed(2)} ms</span> &nbsp;|&nbsp; 
                    <span style="color:#2196f3">Avg JSW Time: ${avgWasm.toFixed(2)} ms</span>
                    <br/>
                    <span style="font-size:0.9em; color:#666">
                        ${faster} is <span style="color:#000">${speedup.toFixed(2)}x</span> faster on average.
                    </span>
                `;

                showToast('Benchmark Complete');
                return;
            }

            // Generate NEW data for this run (Same for both optimized/unoptimized in this step)
            loadLinearData(Math.random()*10000);
            const {data, labels} = prepareData();
            
            // Train JS
            const t0 = performance.now();
            const jsModel = trainModelJs(data, labels, 100, 0.01);
            const t1 = performance.now();
            const jsTime = (t1-t0);
            const jsLoss = computeLoss(jsModel, data, labels, 'js');
            
            // Train Wasm
            const w0 = performance.now();
            const wasmModel = trainModelWasm(data, labels, 100, 0.01);
            const w1 = performance.now();
            const wasmTime = (w1-w0);
            const wasmLoss = computeLoss(wasmModel, data, labels, 'wasm');
            
            benchmarkResults.push({
               run: i+1,
               jsTime, wasmTime, jsLoss, wasmLoss
            });
            
            // Update Table
            const tr = document.createElement('tr');
            tr.innerHTML = `
               <td>${i+1}</td>
               <td>${jsTime.toFixed(2)}</td>
               <td style="font-weight:bold; color:${wasmTime < jsTime ? '#2e7d32' : 'inherit'}">${wasmTime.toFixed(2)}</td>
               <td>${jsLoss}</td>
               <td>${wasmLoss}</td>
            `;
            tableBody.appendChild(tr);
            
            i++;
            btn.textContent = `Running (${i}/${runs})...`;
            
            // Allow UI update
            setTimeout(runStep, 50);
        }
        
        // Start
        setTimeout(runStep, 50);
    });
    
    document.getElementById('btnDownloadCsv').addEventListener('click', () => {
        if(!benchmarkResults.length) return;
        let csv = "Run,JS Time (ms),Wasm Time (ms),JS Loss,Wasm Loss\n";
        benchmarkResults.forEach(r => {
           csv += `${r.run},${r.jsTime.toFixed(4)},${r.wasmTime.toFixed(4)},${r.jsLoss},${r.wasmLoss}\n`; 
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.hidden = true;
        a.href = url;
        a.download = 'benchmark_results.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });
    
    function drawBenchChart() {
        if(!benchmarkResults.length) return;
        const c = document.getElementById('benchChart');
        const cx = c.getContext('2d');
        const w = c.width;
        const h = c.height;
        const padding = 40;
        
        cx.clearRect(0,0,w,h);
        
        // Find Max for scaling
        let maxTime = 0;
        benchmarkResults.forEach(r => maxTime = Math.max(maxTime, r.jsTime, r.wasmTime));
        maxTime = maxTime * 1.1; // padding
        
        // Calculate dimensions
        const chartW = w - 2*padding;
        const chartH = h - 2*padding;
        const count = benchmarkResults.length;
        const slotWidth = chartW / count;
        const barWidth = (slotWidth * 0.6) / 2; // Share slot between 2 bars
        
        const yScale = chartH / maxTime;
        
        // Draw Axis
        cx.beginPath();
        cx.strokeStyle = '#ccc';
        cx.lineWidth = 1;
        // Y Axis
        cx.moveTo(padding, padding);
        cx.lineTo(padding, h - padding);
        // X Axis
        cx.lineTo(w - padding, h - padding);
        cx.stroke();
        
        // Draw Bars
        benchmarkResults.forEach((r, i) => {
            const xBase = padding + i * slotWidth + (slotWidth * 0.2); // center in slot
            
            // JS Bar
            const hJs = r.jsTime * yScale;
            const yJs = h - padding - hJs;
            cx.fillStyle = '#f44336';
            cx.fillRect(xBase, yJs, barWidth, hJs);
            
            // JSW (Wasm) Bar
            const hWasm = r.wasmTime * yScale;
            const yWasm = h - padding - hWasm;
            cx.fillStyle = '#2196f3';
            cx.fillRect(xBase + barWidth, yWasm, barWidth, hWasm);
            
            // Labels (Runs)
            cx.fillStyle = '#666';
            cx.textAlign = 'center';
            cx.font = '10px sans-serif';
            if(count <= 20 || i % 5 === 0) { // prevent crowding
               cx.fillText(r.run, xBase + barWidth, h - padding + 15);
            }
        });
        
        // Legend
        cx.textAlign = 'left';
        cx.font = '12px sans-serif';
        cx.fillStyle = '#f44336';
        cx.fillText('JS Time', w-100, 30);
        cx.fillStyle = '#2196f3';
        cx.fillText('JSW Time', w-100, 50);
    }

    // initial draw
    loadLinearData(200);
  </script>
</body>
</html>
